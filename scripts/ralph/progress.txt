# Ralph Progress Log
Started: Sat Feb 28 07:33:50 PM CET 2026
---

## Codebase Patterns
- Domain config types live in `internal/domain/config/`, config loading logic in `internal/config/`
- SenderConfig has fields: Type, Address, PrivateKey, Safe, Signer, DerivationPath, Governor, Timelock, Proposer
- Tests use `github.com/stretchr/testify/assert` and `require` packages
- Config tests in `internal/config/` are in `package config` (not `config_test`), allowing access to unexported functions
- Domain config tests can be in either `package config` or `package config_test`
- Environment variable expansion uses `os.ExpandEnv()` during config load time
- TOML parsing uses `github.com/BurntSushi/toml`
- For v2 namespace parsing, use `map[string]map[string]string` as the TOML decode target, then manually extract "profile" as reserved key; all other keys become role→account mappings
- BurntSushi/toml handles quoted TOML keys correctly: `[namespace."production.ntt"]` creates key `production.ntt` (dot is literal, not nesting)
- `detectTrebConfigFormat()` returns `TrebConfigFormatV2/V1/None` by checking for top-level keys: accounts/namespace → v2, ns → v1
---

## 2026-02-28 - US-001
- Implemented new domain types in `internal/domain/config/trebfile_v2.go`:
  - `AccountConfig` struct mirroring SenderConfig fields for named signing entities
  - `NamespaceRoles` struct with Profile and Roles map[string]string
  - `TrebFileConfigV2` struct with Accounts, Namespace, and Fork sections
  - `ForkConfig` struct with Setup string
  - `ResolvedNamespace` struct with Profile and Accounts map[string]AccountConfig
- Files changed: `internal/domain/config/trebfile_v2.go`, `internal/domain/config/trebfile_v2_test.go`
- **Learnings for future iterations:**
  - NamespaceRoles.Roles uses `toml:"-"` tag because roles are dynamic string keys parsed manually, not via struct tags
  - AccountConfig intentionally mirrors SenderConfig fields — they're separate types for semantic clarity (accounts are global, senders are namespace-scoped)
  - ResolvedNamespace.Accounts maps role name → AccountConfig (not account name → AccountConfig)
---

## 2026-02-28 - US-002
- Implemented v2 treb.toml parsing in `internal/config/trebfile_v2.go`:
  - `loadTrebConfigV2()` — parses [accounts.*] and [namespace.*] sections with env var expansion
  - `detectTrebConfigFormat()` — returns TrebConfigFormatV2/V1/None based on top-level TOML keys
  - `trebFileV2Raw` helper struct for two-phase TOML decoding (namespace roles need manual extraction)
- Files changed: `internal/config/trebfile_v2.go`, `internal/config/trebfile_v2_test.go`
- **Learnings for future iterations:**
  - `trebFileV2Raw` uses `map[string]map[string]string` for Namespace because all values (profile + role mappings) are flat strings — this avoids custom TOML unmarshaling
  - `loadTrebConfigV2()` returns (nil, nil) for v1 format files since the raw struct's Accounts/Namespace fields stay empty when [ns.*] sections are present (BurntSushi/toml silently ignores undecoded keys)
  - Env var expansion happens on AccountConfig fields only, not on namespace role values (role values are account name references, not secrets)
---
