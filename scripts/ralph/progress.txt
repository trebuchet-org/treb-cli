# Ralph Progress Log
Started: Sat Feb 28 07:33:50 PM CET 2026
---

## Codebase Patterns
- Domain config types live in `internal/domain/config/`, config loading logic in `internal/config/`
- SenderConfig has fields: Type, Address, PrivateKey, Safe, Signer, DerivationPath, Governor, Timelock, Proposer
- Tests use `github.com/stretchr/testify/assert` and `require` packages
- Config tests in `internal/config/` are in `package config` (not `config_test`), allowing access to unexported functions
- Domain config tests can be in either `package config` or `package config_test`
- Environment variable expansion uses `os.ExpandEnv()` during config load time
- TOML parsing uses `github.com/BurntSushi/toml`
- For v2 namespace parsing, use `map[string]map[string]string` as the TOML decode target, then manually extract "profile" as reserved key; all other keys become role→account mappings
- `ResolveNamespace()` walks a dot-separated hierarchy chain built by `buildNamespaceChain()`: for "a.b.c" → ["default", "a", "a.b", "a.b.c"]. Profile and roles overlay at each level.
- BurntSushi/toml handles quoted TOML keys correctly: `[namespace."production.ntt"]` creates key `production.ntt` (dot is literal, not nesting)
- `detectTrebConfigFormat()` returns `TrebConfigFormatV2/V1/None` by checking for top-level keys: accounts/namespace → v2, ns → v1
- AccountConfig and SenderConfig have identical fields — use `config.SenderConfig(acct)` type conversion instead of struct literal (staticcheck S1016)
- `ResolvedNamespaceToTrebConfig()` validates Safe signer and OzGovernor proposer cross-references against the accounts map; keeps account names as-is in the output SenderConfig
- Wire DI: when changing constructor signatures (adding/removing params), update both `wire.go` and `wire_gen.go`; manual edit of `wire_gen.go` works fine
- Viper reads config.local.json fields case-insensitively: JSON key `"forkSetup"` is accessible via `v.GetString("forksetup")`
- For backwards compat config reading, Provider can use viper directly (bypassing the LocalConfig struct) to read legacy fields from config.local.json
- Integration tests: when config.local.json needs fields the LocalConfig struct doesn't have, write the JSON directly in PreSetup instead of using `config set`
---

## 2026-02-28 - US-001
- Implemented new domain types in `internal/domain/config/trebfile_v2.go`:
  - `AccountConfig` struct mirroring SenderConfig fields for named signing entities
  - `NamespaceRoles` struct with Profile and Roles map[string]string
  - `TrebFileConfigV2` struct with Accounts, Namespace, and Fork sections
  - `ForkConfig` struct with Setup string
  - `ResolvedNamespace` struct with Profile and Accounts map[string]AccountConfig
- Files changed: `internal/domain/config/trebfile_v2.go`, `internal/domain/config/trebfile_v2_test.go`
- **Learnings for future iterations:**
  - NamespaceRoles.Roles uses `toml:"-"` tag because roles are dynamic string keys parsed manually, not via struct tags
  - AccountConfig intentionally mirrors SenderConfig fields — they're separate types for semantic clarity (accounts are global, senders are namespace-scoped)
  - ResolvedNamespace.Accounts maps role name → AccountConfig (not account name → AccountConfig)
---

## 2026-02-28 - US-002
- Implemented v2 treb.toml parsing in `internal/config/trebfile_v2.go`:
  - `loadTrebConfigV2()` — parses [accounts.*] and [namespace.*] sections with env var expansion
  - `detectTrebConfigFormat()` — returns TrebConfigFormatV2/V1/None based on top-level TOML keys
  - `trebFileV2Raw` helper struct for two-phase TOML decoding (namespace roles need manual extraction)
- Files changed: `internal/config/trebfile_v2.go`, `internal/config/trebfile_v2_test.go`
- **Learnings for future iterations:**
  - `trebFileV2Raw` uses `map[string]map[string]string` for Namespace because all values (profile + role mappings) are flat strings — this avoids custom TOML unmarshaling
  - `loadTrebConfigV2()` returns (nil, nil) for v1 format files since the raw struct's Accounts/Namespace fields stay empty when [ns.*] sections are present (BurntSushi/toml silently ignores undecoded keys)
  - Env var expansion happens on AccountConfig fields only, not on namespace role values (role values are account name references, not secrets)
---

## 2026-02-28 - US-003
- Implemented hierarchical namespace resolution in `internal/config/trebfile_v2.go`:
  - `ResolveNamespace()` — resolves a namespace by walking the dot-separated hierarchy, overlaying roles and profile at each level
  - `buildNamespaceChain()` — builds ancestry chain from dot-separated name (e.g., "production.ntt" → ["default", "production", "production.ntt"])
  - Validates all role→account references exist; returns error for unknown accounts
- Files changed: `internal/config/trebfile_v2.go`, `internal/config/trebfile_v2_test.go`
- **Learnings for future iterations:**
  - Undefined parent namespaces are silently skipped — if "production" doesn't exist but "production.ntt" does, inheritance goes default → production.ntt
  - Default namespace always exists implicitly as empty (no roles, no profile) even if not defined in config
  - Profile and roles both use simple overlay semantics — child values replace parent values at each level
---

## 2026-02-28 - US-004
- Implemented `ResolvedNamespaceToTrebConfig()` in `internal/config/trebfile_v2.go`:
  - Converts ResolvedNamespace (role→AccountConfig) to TrebConfig (role→SenderConfig) using type conversion
  - Validates Safe signer and OzGovernor proposer cross-references against the global accounts map
  - Returns error for references to non-existent accounts
- Files changed: `internal/config/trebfile_v2.go`, `internal/config/trebfile_v2_test.go`
- **Learnings for future iterations:**
  - AccountConfig and SenderConfig have identical field layouts — use `config.SenderConfig(acct)` type conversion (staticcheck S1016 catches struct literal copies)
  - The signer/proposer fields in output SenderConfig keep the account name as-is; SendersManager already knows how to resolve these references
  - Cross-reference validation only checks that the referenced account exists in the accounts map, not that it's mapped to a role in the current namespace
---

## 2026-02-28 - US-005
- Integrated v2 config loader into Provider() with format detection and routing
  - Added `ForkSetup` field to `RuntimeConfig` struct
  - Updated `Provider()` to call `detectTrebConfigFormat()` first, then route to v2/v1/legacy paths
  - V2 path: `loadTrebConfigV2()` → `ResolveNamespace()` → `ResolvedNamespaceToTrebConfig()`
  - Sets `ConfigSource` to `"treb.toml (v2)"`, `"treb.toml"`, or `"foundry.toml"`
  - Reads `fork.setup` from v2 `[fork]` section into `RuntimeConfig.ForkSetup`
  - Falls back to `cfg.Namespace` when no profile is set in resolved namespace
- Files changed: `internal/domain/config/runtime.go`, `internal/config/provider.go`, `internal/config/provider_test.go`
- **Learnings for future iterations:**
  - Provider uses a switch on `TrebConfigFormat` to route between v2/v1/legacy paths cleanly
  - When v2 namespace has no explicit profile, `FoundryProfile` defaults to the namespace name (same behavior as v1)
  - The v1 path in the switch still calls `loadTrebConfig()` (not `loadTrebConfigV2()`) to maintain exact backwards compatibility
  - All existing tests (including v1 format tests) continue to pass unchanged — the format detection is transparent
---

## 2026-02-28 - US-006
- Moved forkSetup from config.local.json to treb.toml [fork] section:
  - Removed `ForkSetup` field from `LocalConfig` struct and `ConfigKeyForkSetup` constant
  - `config set/remove fork.setup` now returns error with helpful message pointing to treb.toml
  - `enter_fork.go` and `restart_fork.go` now read ForkSetup from `RuntimeConfig` instead of `LocalConfig`
  - Removed `localConfig LocalConfigRepository` dependency from EnterFork and RestartFork use cases
  - Provider reads forkSetup from viper for v1/legacy backwards compat (`v.GetString("forksetup")`)
  - Updated `wire_gen.go` to match new constructor signatures
  - Updated CLI help text, golden files, and integration tests
- Files changed: `internal/domain/config/local.go`, `internal/usecase/enter_fork.go`, `internal/usecase/restart_fork.go`, `internal/usecase/set_config.go`, `internal/usecase/remove_config.go`, `internal/config/provider.go`, `internal/config/provider_test.go`, `internal/app/wire_gen.go`, `internal/cli/config.go`, `test/integration/fork_test.go`, 2 golden files
- **Learnings for future iterations:**
  - When removing a field from a struct used by config set/remove, add an early rejection check in the use case BEFORE the IsValidConfigKey check, so the user gets a specific message instead of "unknown key"
  - Viper can read fields from config.local.json that aren't in the Go struct — useful for backwards compat when removing fields from the struct
  - For integration tests that need raw JSON fields not in the struct, use PreSetup to write config.local.json directly with `os.WriteFile`
  - Wire DI: removing a constructor param means removing it from both the wire.go declarations AND the wire_gen.go generated calls
---

## 2026-02-28 - US-007
- Updated `treb init` to generate new v2 treb.toml format with `[accounts.*]` and `[namespace.*]` sections:
  - New template in `createTrebToml()` includes: `[accounts.deployer]`, `[namespace.default]`, and commented-out `[fork]` section
  - Added helpful comments explaining accounts vs namespaces and dot-separated inheritance
  - Updated render hint text from old `[ns.<namespace>.senders.<name>]` to new `[accounts.<name>]` and `[namespace.<name>]` format
  - Updated 5 golden files (2 treb.toml.golden + 3 commands.golden) to match new output
- Files changed: `internal/usecase/init_project.go`, `internal/cli/render/init.go`, 5 golden files
- **Learnings for future iterations:**
  - The init command template is a hardcoded string in `createTrebToml()` — no template engine or file needed
  - The render file (`internal/cli/render/init.go`) contains "Next steps" hints that reference config format — must be updated when changing config format
  - Three integration test golden files (`init_new_project`, `init_existing_project`, `init_and_deploy`) all contain the "Next steps" text from the renderer
  - The `init_and_deploy` test uses PreSetup to write its own treb.toml (v1 format with anvil sender), so it doesn't test the generated template
---
