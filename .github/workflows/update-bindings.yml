name: Update ABI Bindings

on:
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create pull request for binding updates'
        required: false
        default: true
        type: boolean
  schedule:
    # Check for treb-sol updates daily at 3 AM UTC
    - cron: '0 3 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-bindings:
    name: Update ABI Bindings
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      
      - name: Install abigen
        run: |
          go install github.com/ethereum/go-ethereum/cmd/abigen@latest
      
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Get current treb-sol commit
        id: current
        run: |
          cd treb-sol
          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Update treb-sol submodule
        run: |
          git submodule update --remote treb-sol
      
      - name: Get updated treb-sol commit
        id: updated
        run: |
          cd treb-sol
          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Check if update is needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.commit }}" != "${{ steps.updated.outputs.commit }}" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "✅ treb-sol update detected: ${{ steps.current.outputs.short }} → ${{ steps.updated.outputs.short }}"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "ℹ️ treb-sol is already up to date at ${{ steps.current.outputs.short }}"
          fi
      
      - name: Generate updated ABI bindings
        if: steps.check.outputs.needs_update == 'true'
        run: |
          make bindings
      
      - name: Check for binding changes
        if: steps.check.outputs.needs_update == 'true'
        id: bindings
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "bindings_changed=true" >> $GITHUB_OUTPUT
            echo "✅ ABI bindings updated"
          else
            echo "bindings_changed=false" >> $GITHUB_OUTPUT
            echo "ℹ️ No binding changes needed"
          fi
      
      - name: Verify build works
        if: steps.bindings.outputs.bindings_changed == 'true'
        run: |
          make build
      
      - name: Run tests
        if: steps.bindings.outputs.bindings_changed == 'true'
        run: |
          go test -v ./...
      
      - name: Create Pull Request
        if: steps.bindings.outputs.bindings_changed == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: update ABI bindings to treb-sol ${{ steps.updated.outputs.short }}
            
            - Update treb-sol submodule from ${{ steps.current.outputs.short }} to ${{ steps.updated.outputs.short }}
            - Regenerate ABI bindings with `make bindings`
            
            This is an automated update to keep ABI bindings in sync with treb-sol.
          title: "feat: update ABI bindings to treb-sol ${{ steps.updated.outputs.short }}"
          body: |
            ## 🔄 Automated ABI Binding Update
            
            This PR updates the ABI bindings to match the latest treb-sol contracts.
            
            ### Changes
            - **treb-sol submodule**: `${{ steps.current.outputs.short }}` → `${{ steps.updated.outputs.short }}`
            - **ABI bindings**: Regenerated with `make bindings`
            
            ### Validation
            - ✅ Build passes
            - ✅ Tests pass
            - ✅ Bindings are up to date
            
            ### Review Notes
            Please review the treb-sol changes to ensure they're compatible with the CLI:
            - [Compare treb-sol changes](https://github.com/trebuchet-org/treb-sol/compare/${{ steps.current.outputs.commit }}..${{ steps.updated.outputs.commit }})
            
            This PR is auto-generated and safe to merge if CI passes.
          branch: auto/update-bindings-${{ steps.updated.outputs.short }}
          branch-suffix: timestamp
          delete-branch: true
          draft: false
      
      - name: Commit changes directly (manual trigger)
        if: steps.bindings.outputs.bindings_changed == 'true' && github.event.inputs.create_pr == 'false' && github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "feat: update ABI bindings to treb-sol ${{ steps.updated.outputs.short }}"
          git push
      
      - name: Summary
        run: |
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Current treb-sol**: ${{ steps.current.outputs.short }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Updated treb-sol**: ${{ steps.updated.outputs.short }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update needed**: ${{ steps.check.outputs.needs_update }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bindings changed**: ${{ steps.bindings.outputs.bindings_changed }}" >> $GITHUB_STEP_SUMMARY